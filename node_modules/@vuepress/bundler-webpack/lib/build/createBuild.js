"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createBuild = void 0;
const utils_1 = require("@vuepress/utils");
const webpack = require("webpack");
const utils_2 = require("../utils");
const createClientConfig_1 = require("./createClientConfig");
const createServerConfig_1 = require("./createServerConfig");
const renderPage_1 = require("./renderPage");
const resolveClientManifestMeta_1 = require("./resolveClientManifestMeta");
const createBuild = (options) => async (app) => {
    // webpack compile
    await utils_1.withSpinner('Compiling with webpack')(async () => {
        // create webpack config
        const clientConfig = utils_2.resolveWebpackConfig({
            config: await createClientConfig_1.createClientConfig(app, options),
            options,
            isServer: false,
            isBuild: true,
        });
        const serverConfig = utils_2.resolveWebpackConfig({
            config: await createServerConfig_1.createServerConfig(app, options),
            options,
            isServer: true,
            isBuild: true,
        });
        await new Promise((resolve, reject) => {
            webpack([clientConfig, serverConfig], (err, stats) => {
                var _a, _b;
                if (err) {
                    reject(err);
                }
                else if (stats === null || stats === void 0 ? void 0 : stats.hasErrors()) {
                    (_a = stats.toJson().errors) === null || _a === void 0 ? void 0 : _a.forEach((err) => {
                        console.error(err);
                    });
                    reject(new Error('Failed to compile with errors'));
                }
                else {
                    if (stats === null || stats === void 0 ? void 0 : stats.hasWarnings()) {
                        (_b = stats.toJson().warnings) === null || _b === void 0 ? void 0 : _b.forEach((warning) => {
                            console.warn(warning);
                        });
                    }
                    resolve();
                }
            });
        });
    });
    // render pages
    await utils_1.withSpinner('Rendering pages')(async () => {
        // load ssr template file
        const ssrTemplate = (await utils_1.fs.readFile(app.options.templateSSR)).toString();
        // load the client manifest file
        const clientManifest = require(app.dir.dest(createClientConfig_1.clientManifestFilename));
        // resolve client files meta
        const { allFilesMeta, initialFilesMeta, asyncFilesMeta, moduleFilesMetaMap, } = resolveClientManifestMeta_1.resolveClientManifestMeta(clientManifest);
        // load the compiled server bundle
        const { createVueApp } = require(app.dir.dest('.server/app'));
        // create vue ssr app
        const { app: vueApp, router: vueRouter } = await createVueApp();
        // pre-render pages to html files
        const spinner = utils_1.ora();
        for (const page of app.pages) {
            spinner.start(`Rendering pages ${utils_1.chalk.magenta(page.path)}`);
            await renderPage_1.renderPage({
                app,
                page,
                vueApp,
                vueRouter,
                ssrTemplate,
                allFilesMeta,
                initialFilesMeta,
                asyncFilesMeta,
                moduleFilesMetaMap,
            });
        }
        spinner.stop();
    });
    // keep the server bundle files in debug mode
    if (!app.env.isDebug) {
        // remove server dest directory after pages rendered
        await utils_1.fs.remove(app.dir.dest('.server'));
    }
};
exports.createBuild = createBuild;
